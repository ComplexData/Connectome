---
title: "Connectome Basic Workflow"
author: "Micha Sam Brickman Raredon"
date: "`r Sys.Date()`"
fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Connectome Basic Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
fig_width: 10
fig_height: 7
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Connectome is an R package to automate ligand-receptor mapping and visualization in single-cell data.  It is built to work with Seurat from Satija Lab.

## Load dependencies
```{r message=F, warning=F}
require(Seurat)
require(SeuratData)
require(connectome)
```

## Data Preparation

`CreateConnectome` uses the active identity slot in a Seurat 3.0 object to define "nodes" for network creation and network analysis. 

Node parcellation should be done carefully as it will have a non-trivial effect on downstream connectomics. 

## Load Data
Here, we run *Connectome* on the cross-platform Pancreas data distributed by SeuratData:
```{r message=F, warning=F}
InstallData('panc8')
data('panc8')
table(Idents(panc8))
Idents(panc8) <- panc8[['celltype']]
table(Idents(panc8))
```

## Scale and make connectome
``` {r  message=F, warning=F, include = F}
panc8 <- NormalizeData(panc8)
connectome.genes <- union(connectome::ncomms8866_human$Ligand.ApprovedSymbol,connectome::ncomms8866_human$Receptor.ApprovedSymbol)
genes <- connectome.genes[connectome.genes %in% rownames(panc8)]
panc8 <- ScaleData(panc8,features = genes)
panc8.con <- CreateConnectome(panc8,species = 'human',min.cells.per.ident = 75,p.values = F,calculate.DOR = F)
```

## Filter to edges of interest (critical step - data dependent)
``` {r  message=F, warning=F}
panc8.con2 <- FilterConnectome(panc8.con,min.pct = 0.1,min.z = 0.25,remove.na = T)
```

## Network plot
``` {r  message=F, warning=F}
NetworkPlot(panc8.con2,features = 'VEGFA',min.pct = 0.75,weight.attribute = 'weight_sc')
```

## ModalDotPlot (all modes)
``` {r  message=F, warning=F}
ModalDotPlot(panc8.con2,modes.include = NULL,min.z = NULL,weight.attribute = 'weight_sc')
```

## ModalDotPlot (limited modes)
``` {r  message=F, warning=F}
ModalDotPlot(panc8.con2,modes.include = c('VEGF','WNT','Semaphorins','NOTCH','FGF'),weight.attribute = 'weight_sc',min.z = 0)
```

## CellCellScatter
``` {r  message=F, warning=F}
p1 <- CellCellScatter(panc8.con2,sources.include = 'endothelial',targets.include = 'activated_stellate',
                label.threshold = 3,
                weight.attribute = 'weight_sc',min.pct = 0.25,min.z = 2)
p1 <- p1 + xlim(0,NA) + ylim(0,NA)
p1
```

## SignalScatter
``` {r  message=F, warning=F}
p2 <- SignalScatter(panc8.con2, features = c('JAG1','JAG2','DLL4'),label.threshold = 1,weight.attribute = 'weight_sc',min.z = 2)
p2 <- p2 + xlim(2,NA) + ylim(2,NA)
p2
```

## Four kinds of CircosPlots
First, let's select the top 5 signaling vectors for each cell-cell vector
``` {r  message=F, warning=F}
test <- panc8.con2
test <- data.frame(test %>% group_by(vector) %>% top_n(5,weight_sc))
```

### Edgweights from **normalized** data slot
``` {r  message=F, warning=F}
cells.of.interest <- c('endothelial','activated_stellate','quiescent_stellate','macrophage')
CircosPlot(test,weight.attribute = 'weight_norm',sources.include = cells.of.interest,targets.include = cells.of.interest,lab.cex = 0.4)
```

### Edgweights from **scaled** data slot
``` {r  message=F, warning=F}
CircosPlot(test,weight.attribute = 'weight_sc',sources.include = cells.of.interest,targets.include = cells.of.interest,lab.cex = 0.4)
```

### Ligand-receptor tapered edges from **normalized** data slot
``` {r  message=F, warning=F}
CircosPlot(test,weight.attribute = 'weight_norm',sources.include = cells.of.interest,targets.include = cells.of.interest,balanced.edges = F,lab.cex = 0.4)
```

### Ligand-receptor tapered edges from **scaled** data slot
``` {r  message=F, warning=F}
CircosPlot(test,weight.attribute = 'weight_sc',sources.include = cells.of.interest,targets.include = cells.of.interest,balanced.edges = F,lab.cex = 0.4)
```

## Niche-wise investigation:
``` {r  message=F, warning=F}
CircosPlot(test,targets.include = 'endothelial',lab.cex = 0.4)
```

## Source-wise investigation:
``` {r  message=F, warning=F}
CircosPlot(test,sources.include = 'endothelial',lab.cex = 0.4)
```
